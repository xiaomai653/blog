---
title: SpringBoot整合SpringSecurity
date: 2022-03-10 16:52:31
permalink: /pages/464d7a/
categories:
  - 学习资料
  - Java
  - SpringBoot实战
tags:
  - 
---

## 1.添加依赖
```xml
<!--SpringSecurity依赖配置-->
<dependency>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-security</artifactId>
</dependency>
<!--JWT(Json Web Token)登录支持-->
<dependency>
    <groupId>io.jsonwebtoken</groupId>
    <artifactId>jjwt</artifactId>
    <version>0.9.0</version>
</dependency>
<!--JSON-->
<dependency>
    <groupId>com.alibaba</groupId>
    <artifactId>fastjson</artifactId>
    <version>1.2.59</version>
</dependency>
<!--lombok-->
<dependency>
    <groupId>org.projectlombok</groupId>
    <artifactId>lombok</artifactId>
    <version>1.18.16</version>
</dependency>

```

## 2.配置

### yml配置
```yaml
server:
  port: 8080
spring:
  datasource:
    url: jdbc:mysql://192.168.3.119:3306/zksc_medical?characterEncoding=UTF-8&useUnicode=true&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: 123456
    driver-class-name: com.mysql.cj.jdbc.Driver

# JWT配置
jwt:
   # 密匙Key
   secret: JWTSecret,zksc
   # HeaderKey
   tokenHeader: Authorization
   # Token前缀
   tokenPrefix: Bearer
   # 过期时间，单位秒
   expiration: 1800
   # 配置白名单（不需要认证）
   antMatchers: /login,/refreshToken,/webjars/**,/swagger-ui.html,/swagger-resources/**,/*/api-docs,/websocket/**
```
### 核心配置

#### spring security配置类
```java
import com.springboot.system.filter.JWTAuthenticationFilter;
import com.springboot.system.handler.*;
import com.springboot.system.provider.UserAuthenticationProvider;
import com.springboot.system.provider.UserPermissionProvider;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.config.annotation.authentication.builders.AuthenticationManagerBuilder;
import org.springframework.security.config.annotation.method.configuration.EnableGlobalMethodSecurity;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configuration.WebSecurityConfigurerAdapter;
import org.springframework.security.config.http.SessionCreationPolicy;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.security.web.access.expression.DefaultWebSecurityExpressionHandler;
import org.springframework.security.web.authentication.logout.LogoutFilter;
import org.springframework.web.filter.CorsFilter;

@Configuration
@EnableWebSecurity
@EnableGlobalMethodSecurity(prePostEnabled = true) // 开启方法权限注解
public class SysSecurityConfig extends WebSecurityConfigurerAdapter {

    /**
     * 无权限处理类
     */
    @Autowired
    private UserAccessDeniedHandler userAccessDeniedHandler;

    /**
     * 用户未登录处理类
     */
    @Autowired
    private UserNotLoginHandler userNotLoginHandler;

    /**
     * 用户登录成功处理类
     */
    @Autowired
    private UserLoginSuccessHandler userLoginSuccessHandler;

    /**
     * 用户登录失败处理类
     */
    @Autowired
    private UserLoginFailureHandler userLoginFailureHandler;

    /**
     * 用户登出成功处理类
     */
    @Autowired
    private UserLogoutSuccessHandler userLogoutSuccessHandler;

    /**
     * 跨域过滤器
     */
    @Autowired
    private CorsFilter corsFilter;

    /**
     * 用户登录验证
     */
    @Autowired
    private UserAuthenticationProvider userAuthenticationProvider;

    /**
     * 用户权限注解
     */
    @Autowired
    private UserPermissionProvider userPermissionProvider;


    /**
     * 加密方式
     *
     * @return
     */
    @Bean
    public BCryptPasswordEncoder bCryptPasswordEncoder() {
        return new BCryptPasswordEncoder();
    }


    /**
     * 注入自定义PermissionEvaluator
     *
     * @return
     */
    @Bean
    public DefaultWebSecurityExpressionHandler userSecurityExpressionHandler() {
        DefaultWebSecurityExpressionHandler handler = new DefaultWebSecurityExpressionHandler();
        handler.setPermissionEvaluator(userPermissionProvider);
        return handler;
    }

    /**
     * 用户登录验证
     */
    @Override
    protected void configure(AuthenticationManagerBuilder auth) {
        auth.authenticationProvider(userAuthenticationProvider);
    }

    /**
     * 安全权限配置
     */
    @Override
    protected void configure(HttpSecurity http) throws Exception {
        http.authorizeRequests() // 权限配置
                .antMatchers(JWTConfig.antMatchers.split(",")).permitAll()// 获取白名单（不进行权限验证）
                .anyRequest().authenticated() // 其他的需要登陆后才能访问
                .and().httpBasic().authenticationEntryPoint(userNotLoginHandler) // 配置未登录处理类
                //.and().formLogin().loginProcessingUrl("/system-login")// 配置登录URL
                //.successHandler(userLoginSuccessHandler) // 配置登录成功处理类
                //.failureHandler(userLoginFailureHandler) // 配置登录失败处理类
                .and().logout().logoutUrl("/logout")// 配置登出地址
                .logoutSuccessHandler(userLogoutSuccessHandler) // 配置用户登出处理类
                .and().exceptionHandling().accessDeniedHandler(userAccessDeniedHandler)// 配置没有权限处理类
                .and().cors()// 开启跨域
                .and().csrf().disable(); // 禁用跨站请求伪造防护
        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS); // 禁用session（使用Token认证）
        http.headers().cacheControl(); // 禁用缓存
        http.addFilter(new JWTAuthenticationFilter(authenticationManager())); // 添加JWT过滤器
        http.addFilterBefore(corsFilter, LogoutFilter.class); // 添加CORS filter

    }


    /**
     * 将 AuthenticationManager 注册为 bean , 方便配置 oauth server 的时候使用
     */
    @Bean
    @Override
    public AuthenticationManager authenticationManagerBean() throws Exception {
        return super.authenticationManagerBean();
    }

}
```

#### JWT过滤配置
```java
/**
 * JWT权限过滤器，用于验证Token是否合法
 */
public class JWTAuthenticationFilter extends BasicAuthenticationFilter {

    public JWTAuthenticationFilter(AuthenticationManager authenticationManager) {
        super(authenticationManager);
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain)
            throws IOException, ServletException {
        // 取出Token
        String token = request.getHeader(JWTConfig.tokenHeader);
        if (token != null) {
            if (JWTTokenUtil.verifyToken(token)) {
                ResponseUtils.responseJson(response, Result.fail(SystemErrorType.TOKEN_EXPIRED));
                return;
            }
            String newToken = JWTTokenUtil.verifyExpired(token);
            if (StringUtils.isNotBlank(newToken)) {
                response.setHeader("newToken", newToken);
                response.setHeader("Access-Control-Expose-Headers", "newToken");
                response.setContentType("application/json;charset=utf-8");
                response.setCharacterEncoding("UTF-8");
            }
            SysUserDetails sysUserDetails = JWTTokenUtil.parseAccessToken(token);
            if (sysUserDetails != null) {
                UsernamePasswordAuthenticationToken authentication = new UsernamePasswordAuthenticationToken(
                        sysUserDetails, sysUserDetails.getId(), sysUserDetails.getAuthorities());
                SecurityContextHolder.getContext().setAuthentication(authentication);
            } else {
                ResponseUtils.responseJson(response, Result.fail(SystemErrorType.INVALID_TOKEN));
                return;
            }
        }
        filterChain.doFilter(request, response);
    }

}
```

#### 登录验证
```java
/**
 * 用户登录验证处理类
 */
@Component
public class UserAuthenticationProvider implements AuthenticationProvider {

    @Autowired
    private SysUserDetailsService userDetailsService;

    /**
     * 身份验证
     */
    @Override
    public Authentication authenticate(Authentication authentication) throws AuthenticationException {
        String username = (String) authentication.getPrincipal(); // 获取用户名
        String password = (String) authentication.getCredentials(); // 获取密码
        SysUserDetails sysUserDetails = (SysUserDetails) userDetailsService.loadUserByUsername(username);
        if (sysUserDetails == null) {
            throw new UsernameNotFoundException("用户名不存在");
        }
        if (!new BCryptPasswordEncoder().matches(password, sysUserDetails.getPassword())) {
            throw new BadCredentialsException("用户名或密码错误");
        }
        if (StringUtils.equals(sysUserDetails.getStatus(), "0")) {
            throw new LockedException("用户已禁用");
        }
        return new UsernamePasswordAuthenticationToken(sysUserDetails, password, sysUserDetails.getAuthorities());
    }

    /**
     * 支持指定的身份验证
     */
    @Override
    public boolean supports(Class<?> authentication) {
        return true;
    }

}
```

#### 登录逻辑
```java
/**
 * 用户登录Service
 */
@Service
public class SysUserDetailsService implements UserDetailsService {

    @Autowired
    private SysUserService sysUserService;

    /**
     * 根据用户名查用户信息
     *
     * @param username 用户名
     * @return 用户详细信息
     */
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        SysUser sysUser = sysUserService.findUserByUserName(username);
        if (sysUser != null) {
            SysUserDetails sysUserDetails = new SysUserDetails();
            BeanUtils.copyProperties(sysUser, sysUserDetails);

            Set<GrantedAuthority> authorities = new HashSet<>(); // 角色集合

            List<SysRole> roleList = sysUserService.findRoleByUserId(sysUserDetails.getId());
            if (CollectionUtils.isNotEmpty(roleList)) {
                roleList.forEach(role -> {
                    authorities.add(new SimpleGrantedAuthority("ROLE_" + role.getRoleCode()));
                });
            }
            sysUserDetails.setAuthorities(authorities);

            return sysUserDetails;
        }
        return null;
    }

}
```

#### 权限注解拦截
```java
/**
 * 用户权限注解处理类
 */
@Component
public class UserPermissionProvider implements PermissionEvaluator {

    @Autowired
    private SysUserService sysUserService;

    /**
     * 判断是否拥有权限
     *
     * @param authentication 用户身份
     * @param targetUrl      目标路径
     * @param permission     路径权限
     * @return 是否拥有权限
     */
    @Override
    public boolean hasPermission(Authentication authentication, Object targetUrl, Object permission) {
        SysUserDetails sysUserDetails = null;
        try {
            sysUserDetails = (SysUserDetails) authentication.getPrincipal();
        } catch (Exception e) {
            return false;
        }

        /**
        * 白名单允许访问
        * */
        String[] matchers = JWTConfig.antMatchers.split(",");
        List<String> matchersList = Arrays.asList(matchers);
        if (matchersList.contains(targetUrl)){
            return true;
        }

        Set<String> permissions = new HashSet<String>(); // 用户权限

        List<SysResource> authList = sysUserService.findSourceByUserId(sysUserDetails.getId());
        if (CollectionUtils.isNotEmpty(authList)) {
            authList.forEach(auth -> {
                permissions.add(auth.getPermission());
            });
        }

        // 判断是否拥有权限
        if (permissions.contains(permission.toString())) {
            return true;
        }
        return false;
    }

    @Override
    public boolean hasPermission(Authentication authentication, Serializable targetId, String targetType, Object permission) {
        return false;
    }

}
```

### 工具类

#### JWT工具类
```java
import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.TypeReference;
import com.springboot.system.config.JWTConfig;
import com.springboot.system.entity.SysUserDetails;
import io.jsonwebtoken.Claims;
import io.jsonwebtoken.ExpiredJwtException;
import io.jsonwebtoken.Jwts;
import io.jsonwebtoken.SignatureAlgorithm;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang3.StringUtils;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;

import java.util.*;

/**
 * JWT生产Token工具类
 */
@Slf4j
public class JWTTokenUtil {

    /**
     * 创建Token
     *
     * @param sysUserDetails 用户信息
     * @return
     */
    public static String createAccessToken(SysUserDetails sysUserDetails) {
        String token = Jwts.builder().setId(// 设置JWT
                sysUserDetails.getId()) // 用户Id
                .setSubject(sysUserDetails.getUsername()) // 主题
                .setIssuedAt(new Date()) // 签发时间
                .setIssuer("zksc") // 签发者
                .setExpiration(new Date(System.currentTimeMillis() + JWTConfig.expiration)) // 过期时间
                .signWith(SignatureAlgorithm.HS512, JWTConfig.secret) // 签名算法、密钥
                .claim("authorities", JSON.toJSONString(sysUserDetails.getAuthorities())).compact(); // 自定义其他属性，如用户组织机构ID，用户所拥有的角色，用户权限信息等
        return token;
    }

    /**
     * 创建Token
     *
     * @param claims claims信息
     * @return
     */
    public static String generateToken(Map<String, Object> claims) {
        return Jwts.builder()
                .setClaims(claims)
                .setExpiration(new Date(System.currentTimeMillis() + JWTConfig.expiration))
                .signWith(SignatureAlgorithm.HS512, JWTConfig.secret)
                .compact();
    }

    /**
     * 解析Token
     *
     * @param token Token信息
     * @return
     */
    public static SysUserDetails parseAccessToken(String token) {
        SysUserDetails sysUserDetails = null;
        if (StringUtils.isNotEmpty(token)) {
            try {
                // 去除JWT前缀
                if (token.startsWith(JWTConfig.tokenPrefix)) {
                    token = token.substring(JWTConfig.tokenPrefix.length());
                }
                // 解析Token
                Claims claims = Jwts.parser().setSigningKey(JWTConfig.secret).parseClaimsJws(token).getBody();
                // 获取用户信息
                sysUserDetails = new SysUserDetails();
                sysUserDetails.setId(claims.getId());
                sysUserDetails.setUsername(claims.getSubject());
                // 获取角色
                Set<GrantedAuthority> authorities = new HashSet<GrantedAuthority>();
                String authority = claims.get("authorities").toString();
                if (StringUtils.isNotEmpty(authority)) {
                    List<Map<String, String>> authorityList = JSON.parseObject(authority,
                            new TypeReference<List<Map<String, String>>>() {
                            });
                    for (Map<String, String> role : authorityList) {
                        if (!role.isEmpty()) {
                            authorities.add(new SimpleGrantedAuthority(role.get("authority")));
                        }
                    }
                }
                sysUserDetails.setAuthorities(authorities);
            } catch (Exception e1) {
                log.error("解析Token异常：" + e1.getMessage());
            }
        }
        return sysUserDetails;
    }


    /**
     * 验证Token是否过期
     *
     * @param token Token信息
     * @return
     */
    public static boolean verifyToken(String token) {
        try {
            // 去除JWT前缀
            if (token.startsWith(JWTConfig.tokenPrefix)) {
                token = token.substring(JWTConfig.tokenPrefix.length());
            }
            Jwts.parser().setSigningKey(JWTConfig.secret).parseClaimsJws(token).getBody();
            return false;
        } catch (ExpiredJwtException e) {
            log.debug(e.getMessage());
            Date expiration = e.getClaims().getExpiration();
            return expiration.before(new Date());
        } catch (Exception e1) {
            log.error(e1.getMessage());
            return false;
        }
    }

    /**
     * 刷新Token
     *
     * @param token Token信息
     * @return 新的token
     */
    public static String refreshToken(String token) {
        try {
            // 去除JWT前缀
            if (token.startsWith(JWTConfig.tokenPrefix)) {
                token = token.substring(JWTConfig.tokenPrefix.length());
            }
            Claims claims = Jwts.parser().setSigningKey(JWTConfig.secret).parseClaimsJws(token).getBody();
            return generateToken(claims);
        } catch (ExpiredJwtException e) {
            log.debug(e.getMessage());
            return generateToken(e.getClaims());
        } catch (Exception e1) {
            log.error(e1.getMessage());
            return e1.getMessage();
        }
    }


    /**
     * 过期时间还剩十分钟时刷新Token
     *
     * @param token
     * @return 新的token
     */
    public static String verifyExpired(String token) {
        try {
            // 去除JWT前缀
            if (token.startsWith(JWTConfig.tokenPrefix)) {
                token = token.substring(JWTConfig.tokenPrefix.length());
            }
            Claims claims = Jwts.parser().setSigningKey(JWTConfig.secret).parseClaimsJws(token).getBody();
            long expireTime = claims.getExpiration().getTime();
            long nowTime = new Date().getTime();
            if (expireTime - nowTime < 10 * 60 * 1000) {
                return generateToken(claims);
            } else {
                return null;
            }
        } catch (Exception e1) {
            log.error(e1.getMessage());
            return null;
        }
    }

}
```

#### Response工具类
```java
import com.alibaba.fastjson.JSON;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.extern.slf4j.Slf4j;

import javax.servlet.ServletResponse;
import java.io.PrintWriter;
import java.time.Instant;
import java.time.ZonedDateTime;

@Slf4j
@Data
@AllArgsConstructor
public class ResponseUtils {

    /**
     * 返回编码
     */
    private String code;

    /**
     * 返回消息
     */
    private String msg;

    /**
     * 返回数据
     */
    private Object data;

    /**
     * 请求结果生成时间戳
     */
    private Instant time;

    /**
     * Response输出Json格式
     *
     * @param response
     * @param data     返回数据
     */
    public static void responseJson(ServletResponse response, Object data) {
        PrintWriter out = null;
        try {
            response.setCharacterEncoding("UTF-8");
            response.setContentType("application/json");
            out = response.getWriter();
            out.println(JSON.toJSONString(data));
            out.flush();
        } catch (Exception e) {
            log.error("Response输出Json异常：" + e);
        } finally {
            if (out != null) {
                out.close();
            }
        }
    }

    /**
     * 返回信息
     *
     * @param code 返回编码
     * @param msg  返回消息
     * @param data 返回数据
     * @return
     */
    public static ResponseUtils response(String code, String msg, Object data) {
        return new ResponseUtils(code, msg, data, ZonedDateTime.now().toInstant());
    }
}
```

### Handler配置

#### 无权限
```java

/**
 * 无权限处理类
 */
@Component
public class UserAccessDeniedHandler implements AccessDeniedHandler {

    @Override
    public void handle(HttpServletRequest request, HttpServletResponse response, AccessDeniedException accessDeniedException) {
        ResponseUtils.responseJson(response, Result.fail(SystemErrorType.NO_PERMISSION));
    }

}
```

#### 未登录
```java
/**
 * 未登录处理类
 */
@Component
public class UserNotLoginHandler implements AuthenticationEntryPoint {

    @Override
    public void commence(HttpServletRequest request, HttpServletResponse response,
                         AuthenticationException authException) {
        ResponseUtils.responseJson(response, Result.fail(SystemErrorType.NOT_LOGIN));
    }
    
}
```

#### 登出
```java
/**
 * 登出成功处理类
 */
@Component
public class UserLogoutSuccessHandler implements LogoutSuccessHandler {

    @Override
    public void onLogoutSuccess(HttpServletRequest request, HttpServletResponse response, Authentication authentication) {
        SecurityContextHolder.clearContext();
        ResponseUtils.responseJson(response, Result.success(SystemErrorType.LOGOUT_SUCCESS));
    }
    
}
```

### 其他配置
#### jwt基本配置
```java
import org.springframework.boot.context.properties.ConfigurationProperties;
import org.springframework.stereotype.Component;

/**
 * JWT配置基础类
 */
@Component
@ConfigurationProperties(prefix = "jwt")
@SuppressWarnings("static-access")
public class JWTConfig {

    /**
     * 密匙Key
     */
    public static String secret;

    /**
     * HeaderKey
     */
    public static String tokenHeader;

    /**
     * Token前缀
     */
    public static String tokenPrefix;

    /**
     * 过期时间
     */
    public static Integer expiration;

    /**
     * 配置白名单
     */
    public static String antMatchers;

    /**
     * 将过期时间单位换算成毫秒
     *
     * @param expiration 过期时间，单位秒
     */
    public void setExpiration(Integer expiration) {
        this.expiration = expiration * 1000;
    }

    public void setSecret(String secret) {
        this.secret = secret;
    }

    public void setTokenHeader(String tokenHeader) {
        this.tokenHeader = tokenHeader;
    }

    public void setTokenPrefix(String tokenPrefix) {
        this.tokenPrefix = tokenPrefix + " ";
    }

    public void setAntMatchers(String antMatchers) {
        this.antMatchers = antMatchers;
    }

}
```

#### 跨域配置
```java
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.UrlBasedCorsConfigurationSource;
import org.springframework.web.filter.CorsFilter;

@Configuration
public class CorsConfig {

    private CorsConfiguration buildConfig() {
        CorsConfiguration corsConfiguration = new CorsConfiguration();
        // 1允许任何域名使用
        corsConfiguration.addAllowedOrigin("*");
        // 2允许任何头
        corsConfiguration.addAllowedHeader("*");
        // 3允许任何方法（post、get等）
        corsConfiguration.addAllowedMethod("*");

        corsConfiguration.setAllowCredentials(true);
        return corsConfiguration;
    }

    @Bean
    public CorsFilter corsFilter() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();
        source.registerCorsConfiguration("/**", buildConfig());
        return new CorsFilter(source);
    }

}
```

## 3.使用

### entity层
#### 用户
```java
import com.baomidou.mybatisplus.annotation.*;
import com.springboot.system.entity.vo.SysUserVo;
import lombok.Data;
import org.springframework.beans.BeanUtils;

import java.util.Date;
import java.util.List;
import java.util.Set;

@Data
@TableName("sys_user")
public class SysUser {

    @TableId(type = IdType.ID_WORKER_STR)
    private String id;

    private String number;

    private String username;

    @TableField(exist = false)
    private String oldPassword;

    private String password;

    private String mobile;

    private String avatar;

    private String type;

    private String status = "1";

    @TableLogic
    private String deleted = "N";

    @TableField(exist = false)
    private List roles;

    @TableField(exist = false)
    private Set<String> roleIds;

    @TableField(value = "created_by", fill = FieldFill.INSERT)
    private String createdBy;
    @TableField(value = "created_time", fill = FieldFill.INSERT)
    private Date createdTime;
    @TableField(value = "updated_by", fill = FieldFill.INSERT_UPDATE)
    private String updatedBy;
    @TableField(value = "updated_time", fill = FieldFill.INSERT_UPDATE)
    private Date updatedTime;


    /**
     * po转化为vo
     *
     * @param clazz
     * @return
     */
    public SysUserVo toParam(Class<SysUserVo> clazz) {
        SysUserVo t = BeanUtils.instantiateClass(clazz);
        BeanUtils.copyProperties(this, t);
        return t;
    }
}
```
#### 角色
```java

import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;

import java.util.Date;
import java.util.List;
import java.util.Set;

@Data
@TableName("sys_role")
public class SysRole {

    @TableId(type = IdType.ID_WORKER_STR)
    private String id;

    private String roleCode;

    private String roleName;

    private String roleDescription;

    @TableLogic
    private String deleted = "N";

    @TableField(exist = false)
    private Set<String> resourcesIds;

    @TableField(exist = false)
    private List resources;

    @TableField(value = "created_by", fill = FieldFill.INSERT)
    private String createdBy;
    @TableField(value = "created_time", fill = FieldFill.INSERT)
    private Date createdTime;
    @TableField(value = "updated_by", fill = FieldFill.INSERT_UPDATE)
    private String updatedBy;
    @TableField(value = "updated_time", fill = FieldFill.INSERT_UPDATE)
    private Date updatedTime;

}
```
#### 资源
```java
import com.baomidou.mybatisplus.annotation.*;
import lombok.Data;

import java.util.Date;
import java.util.List;

@Data
@TableName("sys_resource")
public class SysResource {

    @TableId(type = IdType.ID_WORKER_STR)
    private String id;

    private String parentId = "0";

    private String title;

    private String name;

    private String url;

    private String permission;

    @TableLogic
    private String deleted = "N";

    private String menuType;

    private String hidden;

    private String status;

    private String alwaysShow;

    private int orderNumber;

    private String redirect;

    private String icon;

    private String noCache;

    private String affix;

    private String breadcrumb;

    private String component;

    private String activeMenu;

    private String remark;

    @TableField(exist = false)
    private List<SysResource> children;

    @TableField(value = "created_by", fill = FieldFill.INSERT)
    private String createdBy;
    @TableField(value = "created_time", fill = FieldFill.INSERT)
    private Date createdTime;
    @TableField(value = "updated_by", fill = FieldFill.INSERT_UPDATE)
    private String updatedBy;
    @TableField(value = "updated_time", fill = FieldFill.INSERT_UPDATE)
    private Date updatedTime;

}
```
#### 用户角色关联
```java
import com.baomidou.mybatisplus.annotation.*;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.util.Date;

@Data
@AllArgsConstructor
@NoArgsConstructor
@TableName("sys_user_role")
public class SysUserRole {

    @TableId(type = IdType.ID_WORKER_STR)
    private String id;

    private String userId;

    private String roleId;

    @TableLogic
    private String deleted = "N";

    @TableField(value = "created_by", fill = FieldFill.INSERT)
    private String createdBy;
    @TableField(value = "created_time", fill = FieldFill.INSERT)
    private Date createdTime;
    @TableField(value = "updated_by", fill = FieldFill.INSERT_UPDATE)
    private String updatedBy;
    @TableField(value = "updated_time", fill = FieldFill.INSERT_UPDATE)
    private Date updatedTime;

}
```
#### 角色资源关联
```java
import com.baomidou.mybatisplus.annotation.*;
import lombok.AllArgsConstructor;
import lombok.Data;

import java.util.Date;

@Data
@AllArgsConstructor
@TableName("sys_role_resource")
public class SysRoleResource {

    @TableId(type = IdType.ID_WORKER_STR)
    private String id;

    /**
     * 角色ID
     */
    private String roleId;

    /**
     * 权限ID
     */
    private String resourceId;

    @TableLogic
    private String deleted = "N";

    @TableField(value = "created_by", fill = FieldFill.INSERT)
    private String createdBy;
    @TableField(value = "created_time", fill = FieldFill.INSERT)
    private Date createdTime;
    @TableField(value = "updated_by", fill = FieldFill.INSERT_UPDATE)
    private String updatedBy;
    @TableField(value = "updated_time", fill = FieldFill.INSERT_UPDATE)
    private Date updatedTime;

}
```
#### 登录
```java
import com.springboot.system.entity.po.SysUser;
import lombok.Data;
import lombok.EqualsAndHashCode;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;

import java.io.Serializable;
import java.util.Collection;

/**
 * 系统用户详情
 */
@Data
@EqualsAndHashCode(callSuper = false)
public class SysUserDetails extends SysUser implements UserDetails, Serializable {
    private static final long serialVersionUID = 1L;

    /**
     * 用户角色
     */
    private Collection<GrantedAuthority> authorities;

    /**
     * 账号是否过期
     */
    private boolean isAccountNonExpired = false;

    /**
     * 账号是否锁定
     */
    private boolean isAccountNonLocked = false;

    /**
     * 证书是否过期
     */
    private boolean isCredentialsNonExpired = false;

    /**
     * 账号是否有效
     */
    private boolean isEnabled = true;

    /**
     * 获得用户权限
     */
    @Override
    public Collection<? extends GrantedAuthority> getAuthorities() {
        return authorities;
    }

    /**
     * 判断账号是否过期
     */
    @Override
    public boolean isAccountNonExpired() {
        return isAccountNonExpired;
    }

    /**
     * 判断账号是否锁定
     */
    @Override
    public boolean isAccountNonLocked() {
        return isAccountNonLocked;
    }

    /**
     * 判断证书是否过期
     */
    @Override
    public boolean isCredentialsNonExpired() {
        return isCredentialsNonExpired;
    }

    /**
     * 判断账号是否有效
     */
    @Override
    public boolean isEnabled() {
        return isEnabled;
    }

}
```


### mapper层
#### 用户
```java
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.springboot.system.entity.po.SysUser;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

@Mapper
@Repository
public interface SysUserMapper extends BaseMapper<SysUser> {

}
```
#### 角色
```java
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.springboot.system.entity.po.SysRole;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

@Repository
@Mapper
public interface SysRoleMapper extends BaseMapper<SysRole> {
}
```
#### 资源
```java
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.springboot.system.entity.po.SysResource;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

@Repository
@Mapper
public interface SysResourceMapper extends BaseMapper<SysResource> {

}
```
#### 用户角色关联
```java
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.springboot.system.entity.po.SysRole;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

@Repository
@Mapper
public interface SysRoleMapper extends BaseMapper<SysRole> {
}
```
#### 角色资源关联
```java
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.springboot.system.entity.po.SysRoleResource;
import org.apache.ibatis.annotations.Mapper;
import org.springframework.stereotype.Repository;

@Repository
@Mapper
public interface SysRoleResourceMapper extends BaseMapper<SysRoleResource> {
}
```

### Iservice层
#### 用户
```java
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.springboot.common.core.entity.vo.Result;
import com.springboot.system.entity.form.SysUserQueryForm;
import com.springboot.system.entity.po.SysResource;
import com.springboot.system.entity.po.SysRole;
import com.springboot.system.entity.po.SysUser;
import com.springboot.system.entity.vo.SysUserVo;

import javax.servlet.http.HttpServletResponse;
import java.io.Serializable;
import java.util.List;

public interface SysUserService {

    SysUser getById(Serializable id);

    /**
     * 根据用户名称查询用户信息
     *
     * @param username 用户名称
     * @return
     */
    SysUser findUserByUserName(String username);

    /**
     * 根据用户ID查询角色
     *
     * @param userId 用户ID
     * @return
     */
    List<SysRole> findRoleByUserId(String userId);

    /**
     * 根据用户ID查询权限
     *
     * @param userId 用户ID
     * @return
     */
    List<SysResource> findSourceByUserId(String userId);


    /**
     * 根据token查询用户信息
     *
     * @param token
     * @return
     */
    Result findUserByToken(String token);

    /**
     * 添加用户
     *
     * @param sysUser
     * @return
     */
    Result add(SysUser sysUser);

    /**
     * 更新用户信息
     *
     * @param sysUser
     */
    Result update(SysUser sysUser);


    /**
     * 更改头像
     *
     * @param id 用户id
     * @param avatar 头像
     */
    Result updateAvatar(String id,String avatar);

    /**
     * 根据id删除用户
     *
     * @param id
     */
    boolean delete(String id);

    /**
     * 获取用户
     *
     * @param id 用户id
     * @return SysUser
     */
    SysUser get(String id);


    /**
     * 查询用户
     *
     * @return
     */
    IPage<SysUser> query(Page<SysUser> page, SysUserQueryForm sysUserQueryForm);

    /**
     * 导出用户
     *
     * @return
     */
    void exportExcel(HttpServletResponse response);


    /**
     * 根据角色查询用户
     *
     * @return
     */
    Result getUserByRoleId(String roleId);

}
```
#### 角色
```java
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.springboot.common.core.entity.vo.Result;
import com.springboot.system.entity.form.SysRoleQueryForm;
import com.springboot.system.entity.po.SysRole;

import java.io.Serializable;
import java.util.List;

public interface SysRoleService {
    SysRole getById(Serializable id);

    List<SysRole> getRoleByUserId(String userId);

    List<SysRole> getRoleList();

    Result add(SysRole sysRole);

    Result update(SysRole sysRole);

    Result delete(String id);

    SysRole get(String id);

    IPage<SysRole> query(Page<SysRole> page, SysRoleQueryForm sysRoleQueryForm);

}
```
#### 资源
```java
import com.springboot.common.core.entity.vo.Result;
import com.springboot.system.entity.po.SysResource;

import java.io.Serializable;
import java.util.List;

public interface SysResourceService {

    List<SysResource> getResourceByRoleId(String roleId);

    List<SysResource> getResourceByRoleId(String roleId, String menuType);

    boolean save(SysResource sysResource);

    boolean updateById(SysResource sysResource);

    boolean removeById(Serializable id);

    Result delete(String id);

    SysResource getById(Serializable id);

    List<SysResource> getList();

    List<SysResource> getByUserId(String userId, String menuType);

}
```
#### 用户角色关联
```java
import java.util.List;
import java.util.Set;

public interface SysUserRoleService {

    /**
     * 用户Id查询角色Ids
     *
     * @param userId
     * @return
     */
    List<String> getRoleIdsByUserId(String userId);


    /**
     * 给用户添加角色
     *
     * @param userId
     * @param roleIds
     * @return
     */
    boolean saveBatch(String userId, Set<String> roleIds);

    /**
     * 删除用户拥有的角色
     *
     * @param userId
     * @return
     */
    boolean removeByUserId(String userId);

    /**
     * 角色id查询用户ids
     *
     * @param roleId 角色id
     * @return
     */
    List<String> getUserIdsByRoleId(String roleId);

}
```
#### 角色资源关联
```java
import java.util.List;
import java.util.Set;

public interface SysRoleResourceService {


    /**
     * 根据角色id查询资源列表id
     *
     * @param roleId      角色id
     * @return 资源列表id
     */
    List<String> getResourceIdsByRoleId(String roleId);

    /**
     * 批量给角色添加资源
     *
     * @param roleId      角色id
     * @param resourceIds 资源id列表
     * @return 是否操作成功
     */
    boolean saveBatch(String roleId, Set<String> resourceIds);


    /**
     * 删除角色拥有的资源
     *
     * @param roleId 角色id
     * @return 是否操作成功
     */
    boolean removeByRoleId(String roleId);


}
```

### service层
#### 用户
```java
import com.alibaba.fastjson.JSONObject;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.springboot.common.core.entity.vo.Result;
import com.springboot.common.core.exception.SystemErrorType;
import com.springboot.common.core.util.ConfigKeyEnum;
import com.springboot.common.core.util.ExcelUtil;
import com.springboot.system.dao.SysUserMapper;
import com.springboot.system.entity.SysUserDetails;
import com.springboot.system.entity.form.SysUserQueryForm;
import com.springboot.system.entity.po.SysResource;
import com.springboot.system.entity.po.SysRole;
import com.springboot.system.entity.po.SysUser;
import com.springboot.system.entity.vo.SysUserVo;
import com.springboot.system.service.SysResourceService;
import com.springboot.system.service.SysRoleService;
import com.springboot.system.service.SysUserRoleService;
import com.springboot.system.service.SysUserService;
import com.springboot.system.util.JWTTokenUtil;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import javax.servlet.http.HttpServletResponse;
import java.util.*;


@Service
public class SysUserServiceImpl extends ServiceImpl<SysUserMapper, SysUser> implements SysUserService {


    @Autowired
    SysUserMapper userMapper;

    @Autowired
    SysRoleService roleService;

    @Autowired
    SysUserRoleService userRoleService;

    @Autowired
    SysResourceService resourceService;

    @Autowired
    BCryptPasswordEncoder passwordEncoder;

    @Autowired
    SysConfigService configService;

    /**
     * 根据用户名称查询用户信息
     *
     * @param username 用户名称
     * @return
     */
    @Override
    public SysUser findUserByUserName(String username) {
        return this.getOne(new QueryWrapper<SysUser>().apply("binary username = {0}", username));
    }

    /**
     * 根据用户ID查询角色
     *
     * @param userId 用户ID
     * @return
     */
    @Override
    public List<SysRole> findRoleByUserId(String userId) {
        return roleService.getRoleByUserId(userId);
    }

    /**
     * 根据用户ID查询权限
     *
     * @param userId 用户ID
     * @return
     */
    @Override
    public List<SysResource> findSourceByUserId(String userId) {
        List<SysRole> roleList = roleService.getRoleByUserId(userId);
        if (CollectionUtils.isEmpty(roleList)) {
            return null;
        }
        Set<SysResource> sysResources = new HashSet<>();
        for (SysRole sysRole : roleList) {
            List<SysResource> resourceList = resourceService.getResourceByRoleId(sysRole.getId(), "R");
            if (CollectionUtils.isNotEmpty(resourceList)) {
                sysResources.addAll(resourceList);
            }
        }
        ArrayList<SysResource> list = new ArrayList<>();
        list.addAll(sysResources);
        if (CollectionUtils.isEmpty(list)) {
            return null;
        }
        return list;
    }

    /**
     * 根据token查询用户信息
     *
     * @param token
     * @return
     */
    @Override
    public Result findUserByToken(String token) {
        SysUserDetails sysUserDetails = JWTTokenUtil.parseAccessToken(token);
        if (sysUserDetails == null) {
            return Result.fail(SystemErrorType.TOKEN_EXPIRED);
        }
        SysUser user = this.getById(sysUserDetails.getId());
        ArrayList<String> list = new ArrayList<>();
        List<SysRole> roleList = roleService.getRoleByUserId(sysUserDetails.getId());
        for (SysRole sysRole : roleList) {
            list.add(sysRole.getRoleCode());
        }
        user.setRoles(list);
        return Result.success(user.toParam(SysUserVo.class));
    }

    @Override
    public Result add(SysUser sysUser) {
        SysUser user = this.findUserByUserName(sysUser.getUsername());
        if (user != null) {
            return Result.fail("用户已存在！");
        }
        if (StringUtils.isBlank(sysUser.getPassword())) {
            return Result.fail("请输入密码！");
        }
        sysUser.setPassword(passwordEncoder.encode(sysUser.getPassword()));
        this.save(sysUser);
        userRoleService.saveBatch(sysUser.getId(), sysUser.getRoleIds());
        return Result.success();
    }


    @Override
    @Transactional
    public Result update(SysUser sysUser) {
        if (StringUtils.isNotBlank(sysUser.getOldPassword())) {
            SysUser user = this.getById(sysUser.getId());
            boolean matches = passwordEncoder.matches(sysUser.getOldPassword(), user.getPassword());
            if (!matches) {
                return Result.fail("旧密码错误！");
            }
            if (StringUtils.isNotBlank(sysUser.getPassword())) {
                sysUser.setPassword(passwordEncoder.encode(sysUser.getPassword()));
            }
        }
        if (StringUtils.isNotBlank(sysUser.getAvatar())) {
            String nginx = configService.getStrValue(ConfigKeyEnum.NGINX_PIC_PATH.getConfigKey());
            if (sysUser.getAvatar().startsWith(nginx)) {
                sysUser.setAvatar(sysUser.getAvatar().substring(nginx.length()));
            }
        }
        if (StringUtils.isBlank(sysUser.getPassword())) {
            SysUser user = this.getById(sysUser.getId());
            sysUser.setPassword(user.getPassword());
        }
        this.updateById(sysUser);
        userRoleService.saveBatch(sysUser.getId(), sysUser.getRoleIds());
        return Result.success();
    }

    @Override
    public Result updateAvatar(String id, String avatar) {
        SysUser sysUser = this.getById(id);
        if (StringUtils.isNotBlank(avatar)) {
            String nginx = configService.getStrValue(ConfigKeyEnum.NGINX_PIC_PATH.getConfigKey());
            if (avatar.startsWith(nginx)) {
                avatar = avatar.substring(nginx.length());
            }
        }
        sysUser.setAvatar(avatar);
        this.updateById(sysUser);
        return Result.success();
    }

    @Override
    @Transactional
    public boolean delete(String id) {
        this.removeById(id);
        return userRoleService.removeByUserId(id);
    }

    @Override
    public SysUser get(String id) {
        SysUser sysUser = this.getById(id);
        if (Objects.isNull(sysUser)) {
            return null;
        }
        if (StringUtils.isNotBlank(sysUser.getAvatar())) {
            String nginx = configService.getStrValue(ConfigKeyEnum.NGINX_PIC_PATH.getConfigKey());
            StringBuilder stringBuilder = new StringBuilder(nginx);
            stringBuilder.append(sysUser.getAvatar());
            sysUser.setAvatar(stringBuilder.toString());
        }
        List<SysRole> roleList = roleService.getRoleByUserId(sysUser.getId());
        sysUser.setRoles(roleList);
        return sysUser;
    }

    @Override
    public IPage<SysUser> query(Page<SysUser> page, SysUserQueryForm sysUserQueryForm) {
        QueryWrapper<SysUser> queryWrapper = new QueryWrapper<>();
        if (StringUtils.isNotBlank(sysUserQueryForm.getNumber())) {
            queryWrapper.lambda().like(SysUser::getNumber, sysUserQueryForm.getNumber());
        }
        if (StringUtils.isNotBlank(sysUserQueryForm.getUsername())) {
//            queryWrapper.apply("binary username = {0}", sysUserQueryForm.getUsername());
            queryWrapper.lambda().like(SysUser::getUsername, sysUserQueryForm.getUsername());
        }
        if (StringUtils.isNotBlank(sysUserQueryForm.getType())) {
            queryWrapper.lambda().like(SysUser::getType, sysUserQueryForm.getType());
        }
        if (sysUserQueryForm.getCreatedTimeStart() != null && sysUserQueryForm.getCreatedTimeEnd() != null) {
            queryWrapper.lambda().between(SysUser::getCreatedTime, sysUserQueryForm.getCreatedTimeStart(), sysUserQueryForm.getCreatedTimeEnd());
        }
        IPage userPage = this.page(page, queryWrapper);
        ArrayList<SysUserVo> list = new ArrayList<>();
        List<SysUser> records = userPage.getRecords();
        for (SysUser user : records) {
            user.setRoles(roleService.getRoleByUserId(user.getId()));
            list.add(user.toParam(SysUserVo.class));
        }
        userPage.setRecords(list);
        return userPage;
    }

    @Override
    public void exportExcel(HttpServletResponse response) {
        List<SysUser> list = this.list();
        ArrayList<SysUserVo> userVoList = new ArrayList<>();
        for (SysUser user : list) {
            //user.setRoles(roleService.getRoleByUserId(user.getId()));
            userVoList.add(user.toParam(SysUserVo.class));
        }
        ExcelUtil.exportExcel(userVoList, "用户列表", "sheet", SysUserVo.class, "用户列表.xls", response);
    }

    @Override
    public Result getUserByRoleId(String roleId) {
        List<String> userIds = userRoleService.getUserIdsByRoleId(roleId);
        if (userIds == null || userIds.isEmpty()) {
            return Result.success(new ArrayList<>());
        }
        Collection<SysUser> sysUsers = this.listByIds(userIds);
        ArrayList list = new ArrayList<>();
        sysUsers.forEach(sysUser -> {
            JSONObject jsonObject = new JSONObject();
            jsonObject.put("id", sysUser.getId());
            jsonObject.put("username", sysUser.getUsername());
            list.add(jsonObject);
        });
        return Result.success(list);
    }
}
```
#### 角色
```java
import com.baomidou.mybatisplus.core.conditions.query.LambdaQueryWrapper;
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.springboot.admin.entity.po.DailyReminder;
import com.springboot.admin.service.impl.DailyReminderService;
import com.springboot.common.core.entity.vo.Result;
import com.springboot.quartz.service.SysJobService;
import com.springboot.system.dao.SysRoleMapper;
import com.springboot.system.entity.form.SysRoleQueryForm;
import com.springboot.system.entity.po.SysResource;
import com.springboot.system.entity.po.SysRole;
import com.springboot.system.service.SysResourceService;
import com.springboot.system.service.SysRoleResourceService;
import com.springboot.system.service.SysRoleService;
import com.springboot.system.service.SysUserRoleService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;

@Service
public class SysRoleServiceImpl extends ServiceImpl<SysRoleMapper, SysRole> implements SysRoleService {


    @Autowired
    SysUserRoleService userRoleService;

    @Autowired
    SysRoleResourceService roleResourceService;

    @Autowired
    SysResourceService resourceService;

    @Autowired
    DailyReminderService dailyReminderService;

    /**
     * 根据用户ID查询角色
     *
     * @param userId 用户ID
     * @return
     */
    public List<SysRole> getRoleByUserId(String userId) {
        List<String> roleIds = userRoleService.getRoleIdsByUserId(userId);
        if (roleIds.isEmpty()) {
            return new ArrayList<>();
        }
        return (List<SysRole>) this.listByIds(roleIds);
    }

    /**
     * 查询角色列表
     */
    @Override
    public List<SysRole> getRoleList() {
        return this.list();
    }

    /**
     * 添加角色
     *
     * @param sysRole
     * @return Result
     */
    @Override
    @Transactional
    public Result add(SysRole sysRole) {
        SysRole role = this.getOne(new QueryWrapper<SysRole>().lambda().eq(SysRole::getRoleCode, sysRole.getRoleCode()));
        if (role != null) {
            return Result.fail("已经存在该角色");
        }
        this.save(sysRole);
        roleResourceService.saveBatch(sysRole.getId(), sysRole.getResourcesIds());
        return Result.success();
    }

    /**
     * 修改角色
     *
     * @param sysRole
     * @return Result
     */
    @Override
    @Transactional
    public Result update(SysRole sysRole) {
        SysRole sysRoleData = this.getById(sysRole.getId());
        List<DailyReminder> listByRole = dailyReminderService.getListByRole(sysRoleData.getRoleCode());
        //修改每日待办事件里的角色
        if (listByRole.size() != 0 && !sysRole.getRoleCode().equals(sysRoleData.getRoleCode())){
            listByRole.forEach(dailyReminder -> {
                dailyReminder.setRole(sysRole.getRoleCode());
                dailyReminderService.update(dailyReminder);
            });
        }
        this.updateById(sysRole);
        if (CollectionUtils.isNotEmpty(sysRole.getResourcesIds())) {
            roleResourceService.saveBatch(sysRole.getId(), sysRole.getResourcesIds());
        }
        return Result.success();
    }

    /**
     * 删除角色
     *
     * @param id
     * @return Result
     */
    @Override
    public Result delete(String id) {
        SysRole sysRoleData = this.getById(id);
        List<DailyReminder> listByRole = dailyReminderService.getListByRole(sysRoleData.getRoleCode());
        if (listByRole.size() != 0){
            return Result.fail("每日待办事件里存在该角色，请先删除每日待办事件里的角色！");
        }
        this.removeById(id);
        roleResourceService.removeByRoleId(id);
        return Result.success();
    }

    /**
     * 根据id获取角色
     *
     * @param id
     * @return SysRole
     */
    @Override
    public SysRole get(String id) {
        SysRole sysRole = this.getById(id);
        ArrayList<SysResource> list = new ArrayList<>();
        List<String> resourceIds = roleResourceService.getResourceIdsByRoleId(id);
        HashSet<String> set = new HashSet<>();
        set.addAll(resourceIds);
        sysRole.setResourcesIds(set);
        return sysRole;
    }

    @Override
    public IPage<SysRole> query(Page<SysRole> page, SysRoleQueryForm sysRoleQueryForm) {
        LambdaQueryWrapper<SysRole> queryWrapper = new QueryWrapper<SysRole>().lambda();
        if (StringUtils.isNotBlank(sysRoleQueryForm.getRoleName())) {
            queryWrapper.like(SysRole::getRoleName, sysRoleQueryForm.getRoleName());
        }
        return this.page(page, queryWrapper);
    }
}
```
#### 资源
```java
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.springboot.common.core.entity.vo.Result;
import com.springboot.system.dao.SysResourceMapper;
import com.springboot.system.entity.po.SysResource;
import com.springboot.system.entity.po.SysRole;
import com.springboot.system.service.SysResourceService;
import com.springboot.system.service.SysRoleResourceService;
import com.springboot.system.service.SysRoleService;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;

import static java.util.Comparator.comparing;

@Service
public class SysResourceServiceImpl extends ServiceImpl<SysResourceMapper, SysResource> implements SysResourceService {


    @Autowired
    SysRoleService roleService;

    @Autowired
    SysRoleResourceService roleResourceService;


    /**
     * 根据角色ID查询资源
     *
     * @param roleId 用角色ID
     * @return
     */
    public List<SysResource> getResourceByRoleId(String roleId) {
        List<String> resourceIds = roleResourceService.getResourceIdsByRoleId(roleId);
        if (CollectionUtils.isEmpty(resourceIds)) {
            return null;
        }
        return (List<SysResource>) this.listByIds(resourceIds);
    }


    /**
     * 根据角色ID查询后端资源
     *
     * @param roleId 用角色ID
     * @return
     */
    public List<SysResource> getResourceByRoleId(String roleId, String menuType) {
        List<String> resourceIds = roleResourceService.getResourceIdsByRoleId(roleId);
        if (CollectionUtils.isEmpty(resourceIds)) {
            return null;
        }
        ArrayList<SysResource> list = new ArrayList<>();
        Collection<SysResource> sysResources = this.listByIds(resourceIds);
        sysResources.forEach(sysResource -> {
            if (StringUtils.isNotBlank(sysResource.getPermission()) || StringUtils.equals(menuType, sysResource.getMenuType())) {
                list.add(sysResource);
            }
        });
        return list;
    }

    /**
     * 根据ID删除资源
     *
     * @param id 资源ID
     * @return
     */
    @Override
    public Result delete(String id) {
        List<SysResource> list = this.list(new QueryWrapper<SysResource>().lambda().eq(SysResource::getParentId, id));
        if (CollectionUtils.isNotEmpty(list)) {
            return Result.fail("存在下级菜单，不允许删除！");
        }
        this.removeById(id);
        return Result.success();
    }


    /**
     * 获取资源列表
     * 通过树的形式返回
     */
    @Override
    public List<SysResource> getList() {
        List<SysResource> resourceList = this.list();
        if (CollectionUtils.isEmpty(resourceList)) {
            return null;
        }
        //拿到顶级菜单
        ArrayList<SysResource> list = new ArrayList<>();
        for (SysResource sysResource : resourceList) {
            if (StringUtils.equals(sysResource.getParentId(), "0")) {
                list.add(sysResource);
            }
        }
        list.sort(comparing(SysResource::getOrderNumber));
        //循环顶级菜单设置子菜单
        for (SysResource sysResource : list) {
            sysResource.setChildren(getResourceChildren(sysResource.getId(), resourceList));
        }
        return list;
    }

    /**
     * 根据用户ID查询资源
     *
     * @param userId   用户id
     * @param menuType 菜单类型
     * @return: 资源列表
     */
    @Override
    public List<SysResource> getByUserId(String userId, String menuType) {
        List<SysRole> roleList = roleService.getRoleByUserId(userId);
        if (CollectionUtils.isEmpty(roleList)) {
            return null;
        }
        HashSet<String> set = new HashSet<>();
        roleList.forEach(sysRole -> {
            List<String> resourceIds = roleResourceService.getResourceIdsByRoleId(sysRole.getId());
            set.addAll(resourceIds);
        });
        if (CollectionUtils.isEmpty(set)) {
            return new ArrayList<>();
        }
        List<SysResource> resourceList = this.list(new QueryWrapper<SysResource>().lambda().eq(SysResource::getMenuType, menuType).in(SysResource::getId, set));
        //拿到顶级菜单
        ArrayList<SysResource> list = new ArrayList<>();
        for (SysResource sysResource : resourceList) {
            if (StringUtils.equals(sysResource.getParentId(), "0")) {
                list.add(sysResource);
            }
        }
        list.sort(comparing(SysResource::getOrderNumber));
        //循环顶级菜单设置子菜单
        for (SysResource sysResource : list) {
            sysResource.setChildren(getResourceChildren(sysResource.getId(), resourceList));
        }
        return list;
    }

    /**
     * 递归查询资源
     *
     * @param list 顶级资源列表
     * @return: 资源列表
     */
    private List<SysResource> getResourceChildren(String id, List<SysResource> list) {
        List<SysResource> childrenList = new ArrayList<>();
        if (CollectionUtils.isEmpty(list)) {
            return null;
        }
        for (SysResource sysResource : list) {
            if (StringUtils.equals(sysResource.getParentId(), id)) {
                childrenList.add(sysResource);
            }
        }
        for (SysResource sysResource : childrenList) {
            sysResource.setChildren(getResourceChildren(sysResource.getId(), list));
        }
        childrenList.sort(comparing(SysResource::getOrderNumber));
        return childrenList;
    }

}
```
#### 用户角色关联
```java
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.springboot.system.dao.SysUserRoleMapper;
import com.springboot.system.entity.po.SysUserRole;
import com.springboot.system.service.SysUserRoleService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Service
public class SysUserRoleServiceImpl extends ServiceImpl<SysUserRoleMapper, SysUserRole> implements SysUserRoleService {


    /**
     * 根据用户ID查询角色ids
     *
     * @param userId 用户ID
     * @return
     */
    @Override
    public List<String> getRoleIdsByUserId(String userId) {
        List<SysUserRole> sysUserRoles = this.list(new QueryWrapper<SysUserRole>().lambda().eq(SysUserRole::getUserId, userId));
        if (sysUserRoles.isEmpty()) {
            return new ArrayList<>();
        }
        ArrayList<String> list = new ArrayList<>();
        for (SysUserRole sysUserRole : sysUserRoles) {
            list.add(sysUserRole.getRoleId());
        }
        return list;
    }


    @Override
    @Transactional
    public boolean saveBatch(String userId, Set<String> roleIds) {
        if (CollectionUtils.isEmpty(roleIds)) {
            return false;
        }
        removeByUserId(userId);
        Set<SysUserRole> userRoles = roleIds.stream().map(roleId -> new SysUserRole(null, userId, roleId, "N", null, null, null, null)).collect(Collectors.toSet());
        return saveBatch(userRoles);
    }

    @Override
    @Transactional
    public boolean removeByUserId(String userId) {
        return remove(new QueryWrapper<SysUserRole>().lambda().eq(SysUserRole::getUserId, userId));
    }

    @Override
    public List<String> getUserIdsByRoleId(String roleId) {
        List<SysUserRole> sysUserRoles = this.list(new QueryWrapper<SysUserRole>().lambda().eq(SysUserRole::getRoleId, roleId));
        if (sysUserRoles.isEmpty()) {
            return new ArrayList<>();
        }
        ArrayList<String> list = new ArrayList<>();
        for (SysUserRole sysUserRole : sysUserRoles) {
            list.add(sysUserRole.getUserId());
        }
        return list;
    }

}
```
#### 角色资源关联
```java
import com.baomidou.mybatisplus.core.conditions.query.QueryWrapper;
import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.springboot.system.dao.SysRoleResourceMapper;
import com.springboot.system.entity.po.SysRoleResource;
import com.springboot.system.service.SysRoleResourceService;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Service
public class SysRoleResourceServiceImpl extends ServiceImpl<SysRoleResourceMapper, SysRoleResource> implements SysRoleResourceService {


    /**
     * 根据角色ID查询资源ids
     *
     * @param roleId 用角色ID
     * @return
     */
    @Override
    public List<String> getResourceIdsByRoleId(String roleId) {
        List<SysRoleResource> sysRoleResources = this.list(new QueryWrapper<SysRoleResource>().lambda().eq(SysRoleResource::getRoleId, roleId));
        ArrayList<String> list = new ArrayList<>();
        for (SysRoleResource sysRoleResource : sysRoleResources) {
            list.add(sysRoleResource.getResourceId());
        }
        return list;
    }

    @Override
    public boolean saveBatch(String roleId, Set<String> resourceIds) {
        if (CollectionUtils.isEmpty(resourceIds)) {
            return false;
        }
        this.removeByRoleId(roleId);
        Set<SysRoleResource> userRoles = resourceIds.stream().map(resourceId -> new SysRoleResource(null, roleId, resourceId, "N", null, null, null, null)).collect(Collectors.toSet());
        return saveBatch(userRoles);
    }


    public boolean removeByRoleId(String roleId) {
        QueryWrapper<SysRoleResource> queryWrapper = new QueryWrapper<>();
        queryWrapper.lambda().eq(SysRoleResource::getRoleId, roleId);
        return remove(queryWrapper);
    }

}
```
#### 登录
```java
import com.baomidou.mybatisplus.core.toolkit.CollectionUtils;
import com.springboot.system.entity.SysUserDetails;
import com.springboot.system.entity.po.SysRole;
import com.springboot.system.entity.po.SysUser;
import com.springboot.system.service.SysUserService;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.HashSet;
import java.util.List;
import java.util.Set;

/**
 * 用户登录Service
 */
@Service
public class SysUserDetailsService implements UserDetailsService {

    @Autowired
    private SysUserService sysUserService;

    /**
     * 根据用户名查用户信息
     *
     * @param username 用户名
     * @return 用户详细信息
     */
    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        SysUser sysUser = sysUserService.findUserByUserName(username);
        if (sysUser != null) {
            SysUserDetails sysUserDetails = new SysUserDetails();
            BeanUtils.copyProperties(sysUser, sysUserDetails);

            Set<GrantedAuthority> authorities = new HashSet<>(); // 角色集合

            List<SysRole> roleList = sysUserService.findRoleByUserId(sysUserDetails.getId());
            if (CollectionUtils.isNotEmpty(roleList)) {
                roleList.forEach(role -> {
                    authorities.add(new SimpleGrantedAuthority("ROLE_" + role.getRoleCode()));
                });
            }
            sysUserDetails.setAuthorities(authorities);

            return sysUserDetails;
        }
        return null;
    }
}
```

### controller层
#### 用户
```java
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.springboot.admin.service.IOutsideAuditSchemeService;
import com.springboot.aop.annotation.SysLog;
import com.springboot.aop.enums.SysOperateLogEnum;
import com.springboot.common.core.entity.vo.Result;
import com.springboot.system.entity.form.SysUserQueryForm;
import com.springboot.system.entity.po.SysUser;
import com.springboot.system.entity.vo.SysUserVo;
import com.springboot.system.service.SysUserService;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletResponse;
import javax.validation.Valid;


@Slf4j
@RestController
@RequestMapping("/user")
public class SysUserController {

    @Autowired
    SysUserService userService;
    @Autowired
    IOutsideAuditSchemeService outsideAuditSchemeService;

    @ApiOperation(value = "根据token获取用户", notes = "根据token获取用户")
    @ApiImplicitParam(name = "token", value = "token", required = true, dataType = "String")
    @PreAuthorize(value = "hasPermission('/user/info','sys:user:info')")
    @PostMapping("/info")
    public Result info(@RequestParam("token") String token) {
        log.debug("get user with token:{}", token);
        return userService.findUserByToken(token);
    }

    @ApiOperation(value = "新增用户", notes = "新增一个用户")
    @ApiImplicitParam(name = "sysUser", value = "新增用户sysUser表单", required = true, dataType = "SysUser")
    @SysLog(operateModel = "用户管理", operateType = SysOperateLogEnum.INSERT)
    @PreAuthorize(value = "hasPermission('/user/add','sys:user:add')")
    @PostMapping("/add")
    public Result add(@Valid @RequestBody SysUser sysUser) {
        log.debug("add user with:{}", sysUser);
        return userService.add(sysUser);
    }

    @ApiOperation(value = "修改用户", notes = "修改指定用户信息")
    @ApiImplicitParam(name = "SysUser", value = "用户实体", required = true, dataType = "SysUser")
    @SysLog(operateModel = "用户管理", operateType = SysOperateLogEnum.UPDATE)
    @PreAuthorize(value = "hasPermission('/user/update','sys:user:update')")
    @PutMapping(value = "/update")
    public Result update(@Valid @RequestBody SysUser sysUser) {
        log.debug("update user with:{}", sysUser);
        return userService.update(sysUser);
    }

    @ApiOperation(value = "修改头像", notes = "修改头像")
    @SysLog(operateModel = "用户管理", operateType = SysOperateLogEnum.UPDATE)
    @PreAuthorize(value = "hasPermission('/user/updateAvatar','sys:user:updateAvatar')")
    @PutMapping(value = "/updateAvatar")
    public Result updateAvatar(@RequestParam String id,@RequestParam String avatar) {
        log.debug("update avatar with userId:{}", id);
        return userService.updateAvatar(id,avatar);
    }

    @ApiOperation(value = "删除用户", notes = "根据id来指定删除对象，逻辑删除")
    @SysLog(operateModel = "用户管理", operateType = SysOperateLogEnum.DELETE)
    @PreAuthorize(value = "hasPermission('/user/delete','sys:user:del')")
    @DeleteMapping(value = "/delete")
    public Result delete(@RequestParam String id) {
        log.debug("delete user for:{}", id);
        if (outsideAuditSchemeService.checkByUserId(id)) {
            return Result.fail("该用户id在所外审批方案中被使用，无法删除！");
        }
        boolean result = userService.delete(id);
        if (result) {
            return Result.success();
        }
        return Result.fail();
    }

    @ApiOperation(value = "获取用户", notes = "获取指定用户信息")
    @PreAuthorize(value = "hasPermission('/user/get','sys:user:get')")
    @GetMapping(value = "/get")
    public Result get(@RequestParam String id) {
        log.debug("get user with id:{}", id);
        SysUser user = userService.get(id);
        SysUserVo sysUserVo = user.toParam(SysUserVo.class);
        return Result.success(sysUserVo);
    }


    @ApiOperation(value = "搜索用户", notes = "根据条件查询用户信息")
    @ApiImplicitParam(name = "sysUserQueryForm", value = "用户查询参数", required = true, dataType = "SysUserQueryForm")
    @PreAuthorize(value = "hasPermission('/user/query','sys:user:query')")
    @PostMapping(value = "/query")
    public Result query(@Valid @RequestBody SysUserQueryForm sysUserQueryForm) {
        log.debug("query with sysUserQueryForm:{}", sysUserQueryForm);
        IPage<SysUser> userVoIPage = userService.query(sysUserQueryForm.getPage(), sysUserQueryForm);
        return Result.success(userVoIPage);
    }

    @ApiOperation(value = "导出用户列表", notes = "导出用户列表")
    @SysLog(operateModel = "用户管理", operateType = SysOperateLogEnum.EXPORT)
    @PreAuthorize(value = "hasPermission('/user/export','sys:user:export')")
    @GetMapping(value = "/export")
    public void export(HttpServletResponse response) {
        log.debug("export user list");
        userService.exportExcel(response);
    }


    @ApiOperation(value = "获取用户", notes = "根据角色获取用户")
    @PreAuthorize(value = "hasPermission('/user/getUserByRoleId','sys:user:getUserByRoleId')")
    @GetMapping(value = "/getUserByRoleId")
    public Result getUserByRole(@RequestParam String roleId) {
        log.debug("get user roleId:{}", roleId);
        return userService.getUserByRoleId(roleId);
    }

}
```
#### 角色
```java
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.springboot.aop.annotation.SysLog;
import com.springboot.aop.enums.SysOperateLogEnum;
import com.springboot.common.core.entity.vo.Result;
import com.springboot.admin.service.IOutsideAuditSchemeService;
import com.springboot.system.entity.form.SysRoleQueryForm;
import com.springboot.system.entity.po.SysRole;
import com.springboot.system.entity.po.SysUser;
import com.springboot.system.service.SysRoleService;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;

@Slf4j
@RestController
@RequestMapping("/role")
public class SysRoleController {

    @Autowired
    SysRoleService roleService;
    @Autowired
    IOutsideAuditSchemeService outsideAuditSchemeService;


    @ApiOperation(value = "新增角色", notes = "新增一个角色")
    @ApiImplicitParam(name = "SysRole", value = "新增角色SysRole表单", required = true, dataType = "SysRole")
    @SysLog(operateModel = "角色管理", operateType = SysOperateLogEnum.INSERT)
    @PreAuthorize(value = "hasPermission('/role/add','sys:role:add')")
    @PostMapping("/add")
    public Result add(@Valid @RequestBody SysRole sysRole) {
        log.debug("add role with:{}", sysRole);
        return roleService.add(sysRole);
    }


    @ApiOperation(value = "修改角色", notes = "修改指定角色信息")
    @ApiImplicitParam(name = "SysRole", value = "角色实体", required = true, dataType = "SysRole")
    @SysLog(operateModel = "角色管理", operateType = SysOperateLogEnum.UPDATE)
    @PreAuthorize(value = "hasPermission('/role/update','sys:role:update')")
    @PutMapping(value = "/update")
    public Result update(@Valid @RequestBody SysRole sysRole) {
        log.debug("update role with:{}", sysRole);
        return roleService.update(sysRole);
    }

    @ApiOperation(value = "删除角色", notes = "根据id来指定删除角色，逻辑删除")
    @ApiImplicitParam(paramType = "param", name = "id", value = "角色ID", required = true, dataType = "string")
    @SysLog(operateModel = "角色管理", operateType = SysOperateLogEnum.DELETE)
    @PreAuthorize(value = "hasPermission('/role/delete','sys:role:del')")
    @DeleteMapping(value = "/delete")
    public Result delete(@RequestParam String id) {
        log.debug("delete role for:{}", id);
        if(outsideAuditSchemeService.checkByRoleId(id)){
            return Result.fail("该角色id在所外审批方案中被使用，无法删除！");
        }
        return roleService.delete(id);
    }

    @ApiOperation(value = "获取角色", notes = "获取指定角色信息")
    @ApiImplicitParam(paramType = "param", name = "id", value = "角色ID", required = true, dataType = "string")
    @PreAuthorize(value = "hasPermission('/role/get','sys:role:get')")
    @GetMapping(value = "/get")
    public Result get(@RequestParam String id) {
        log.debug("get role with id:{}", id);
        SysRole sysRole = roleService.get(id);
        return Result.success(sysRole);
    }


    @ApiOperation(value = "搜索角色", notes = "根据条件查询角色信息")
    @ApiImplicitParam(name = "SysRoleQueryForm", value = "角色查询参数", required = true, dataType = "SysRoleQueryForm")
    @PreAuthorize(value = "hasPermission('/role/query','sys:role:query')")
    @PostMapping(value = "/query")
    public Result query(@Valid @RequestBody SysRoleQueryForm sysRoleQueryForm) {
        log.debug("query with sysRoleQueryForm:{}", sysRoleQueryForm);
        IPage<SysUser> userVoIPage = roleService.query(sysRoleQueryForm.getPage(), sysRoleQueryForm);
        return Result.success(userVoIPage);
    }

    @ApiOperation(value = "查询角色列表", notes = "查询角色列表")
    @PreAuthorize(value = "hasPermission('/role/lsit','sys:role:list')")
    @GetMapping("/list")
    public Result list() {
        return Result.success(roleService.getRoleList());
    }

}
```
#### 资源
```java
import com.springboot.aop.annotation.SysLog;
import com.springboot.aop.enums.SysOperateLogEnum;
import com.springboot.common.core.entity.vo.Result;
import com.springboot.system.entity.po.SysResource;
import com.springboot.system.service.SysResourceService;
import io.swagger.annotations.ApiImplicitParam;
import io.swagger.annotations.ApiOperation;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.lang.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.access.prepost.PreAuthorize;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import java.util.List;

@Slf4j
@RestController
@RequestMapping("/resource")
public class SysResourceController {

    @Autowired
    SysResourceService resourceService;


    @ApiOperation(value = "新增资源", notes = "新增一个资源")
    @ApiImplicitParam(name = "SysResource", value = "新增资源SysResource表单", required = true, dataType = "SysResource")
    @SysLog(operateModel = "菜单资源管理", operateType = SysOperateLogEnum.INSERT)
    @PreAuthorize(value = "hasPermission('/resource/add','sys:resource:add')")
    @PostMapping("/add")
    public Result add(@Valid @RequestBody SysResource sysResource) {
        log.debug("add resource with:{}", sysResource);
        if (StringUtils.isBlank(sysResource.getParentId())) {
            sysResource.setParentId("0");
        }
        boolean result = resourceService.save(sysResource);
        if (result) {
            return Result.success();
        }
        return Result.fail();
    }

    @ApiOperation(value = "修改资源", notes = "修改指定资源信息")
    @ApiImplicitParam(name = "SysResource", value = "资源实体", required = true, dataType = "SysResource")
    @SysLog(operateModel = "菜单资源管理", operateType = SysOperateLogEnum.UPDATE)
    @PreAuthorize(value = "hasPermission('/resource/update','sys:resource:update')")
    @PutMapping(value = "/update")
    public Result update(@Valid @RequestBody SysResource sysResource) {
        log.debug("update resource with:{}", sysResource);
        boolean result = resourceService.updateById(sysResource);
        if (result) {
            return Result.success();
        }
        return Result.fail();
    }

    @ApiOperation(value = "删除资源", notes = "根据id来指定删除对象，逻辑删除")
    @ApiImplicitParam(paramType = "param", name = "id", value = "资源ID", required = true, dataType = "string")
    @SysLog(operateModel = "菜单资源管理", operateType = SysOperateLogEnum.DELETE)
    @PreAuthorize(value = "hasPermission('/resource/delete','sys:resource:del')")
    @DeleteMapping(value = "/delete")
    public Result delete(@RequestParam String id) {
        log.debug("delete resource for:{}", id);
        return resourceService.delete(id);
    }

    @ApiOperation(value = "获取资源", notes = "获取指定资源信息")
    @ApiImplicitParam(paramType = "param", name = "id", value = "资源ID", required = true, dataType = "string")
    @PreAuthorize(value = "hasPermission('/resource/get','sys:resource:get')")
    @GetMapping(value = "/get")
    public Result get(@RequestParam String id) {
        log.debug("get resource with id:{}", id);
        SysResource sysResource = resourceService.getById(id);
        return Result.success(sysResource);
    }


    @ApiOperation(value = "资源列表", notes = "资源列表")
    @PreAuthorize(value = "hasPermission('/resource/list','sys:resource:list')")
    @GetMapping(value = "/list")
    public Result list() {
        log.debug("query resource list");
        return Result.success(resourceService.getList());
    }


    @ApiOperation(value = "获取资源", notes = "获取指定资源信息")
    @PreAuthorize(value = "hasPermission('/resource/getByUserId','sys:resource:getByUserId')")
    @GetMapping(value = "/getByUserId")
    public Result getByUserId(@RequestParam String userId, @RequestParam String menuType) {
        log.debug("get resource with userId:{}", userId);
        List<SysResource> resourceList = resourceService.getByUserId(userId, menuType);
        return Result.success(resourceList);
    }

}
```
#### 登录
```java
import com.springboot.common.core.entity.vo.Result;
import com.springboot.system.entity.SysUserDetails;
import com.springboot.system.entity.po.SysUser;
import com.springboot.system.provider.UserAuthenticationProvider;
import com.springboot.system.service.impl.SysUserDetailsService;
import com.springboot.system.util.JWTTokenUtil;
import io.swagger.annotations.ApiOperation;
import lombok.SneakyThrows;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestBody;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;

import javax.servlet.http.HttpServletRequest;
import javax.validation.Valid;
import java.util.Base64;


@RestController
public class LoginController {

    @Autowired
    private SysUserDetailsService userDetailsService;

    @Autowired
    private UserAuthenticationProvider authenticationProvider;

    /**
     * 使用 /login 请求获得 token, /login 不经过拦截器
     */
    @SneakyThrows
    @PostMapping("/login")
    @ApiOperation(value = "登录接口", notes = "登录接口")
    public Result login(@Valid @RequestBody SysUser user, HttpServletRequest request) {

        // 密码通过base64解码
        byte[] decode = Base64.getDecoder().decode(user.getPassword());
        String password = new String(decode, "UTF-8");

        UserDetails userDetails = userDetailsService.loadUserByUsername(user.getUsername());
        // 通过 username 和 password 构建一个 Authentication 对象
        UsernamePasswordAuthenticationToken authRequest = new UsernamePasswordAuthenticationToken(user.getUsername(), password);
        authenticationProvider.authenticate(authRequest, request);
        String accessToken = JWTTokenUtil.createAccessToken((SysUserDetails) userDetails);
        return Result.success(accessToken);
    }

    @ApiOperation(value = "刷新token接口", notes = "刷新token接口")
    @PostMapping("/refreshToken")
    public Result refreshToken(@RequestParam String token) {
        return Result.success(JWTTokenUtil.refreshToken(token));
    }

}
```